<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>German Vocab</title>
</head>
<body>
<div id="setup">
    <label for="ordering">Ordering:</label>
    <select id="ordering">
        <option value="random">Random</option>
        <option value="sequential">Sequential</option>
    </select>
    <br>
    <label for="submit_method">Submit Method:</label>
    <select id="submit_method">
        <option value="auto">Automatic</option>
        <option value="manual">Answer upon Submit</option>
    </select>
    <br>
    <label for="german_characters">German Characters:</label>
    <select id="german_characters">
        <option value="strict">Require German Characters or "-e" for Umlauts and "ss" for Essets</option>
        <option value="lenient">Accept Non-Umlaut Counterparts for Umlauts and "s" for Essets</option>
    </select>
    <form id="question_threshold_box">
        Question Threshold: Don't Ask Questions with Greater than <input type="text" id="question_threshold"> % Correct
        <br>
        <span id="question_threshold_error"></span>
    </form>
    <form id="length_box">
        Quiz Length: <input type="text" id="length"> Questions
        <br>
        <span id="length_error"></span>
    </form>
    <form id="begin_quiz">
        <button type="submit">Begin Quiz</button>
    </form>
</div>
<div id="quiz">
    <p id="question_count"></p>
    <p id="question"></p>
    <form id="answer_box">
        <input type="text" id="answer">
        <button type="submit">Submit</button>
    </form>
    <p id="result"></p>
    <form id="end_quiz">
        <button type="submit">See Report</button>
    </form>
</div>
<div id="quiz_report">
    <scan id="grade"></scan>
    <form id="reset_quiz">
        <button type="submit">Reset</button>
    </form>
    <form id="restart_quiz">
        <button type="submit">Restart</button>
    </form>
    <form id="new_quiz">
        <button type="submit">New Quiz</button>
    </form>
    <form id="download_quiz_data">
        <button type="submit">Download Quiz Data</button>
    </form>
</div>
<script>
    const result = document.getElementById("result")
    document.getElementById("quiz").style.display = "none"
    document.getElementById("quiz_report").style.display = "none"
    document.getElementById("end_quiz").style.display = "none"
    const quiz_parameters = {}
    let order
    let index
    let correct_count
    let keys
    let quiz_data
    let max_length
    let min_threshold
    async function fetch_csv(csv) {
        let rows = await fetch(csv)
        rows = await rows.text()
        return rows
    }
    function begin_quiz() {
        event.preventDefault()
        index = 0
        correct_count = 0
        document.getElementById("setup").style.display = "none"
        document.getElementById("quiz_report").style.display = "none"
        document.getElementById("quiz").style.display = "block"
        document.getElementById("answer_box").style.display = "block"
        document.getElementById("end_quiz").style.display = "none"
        result.innerHTML = ""
        document.getElementById("question_count").innerHTML = "Question " + (index + 1) + "/" + quiz_parameters.length
        document.getElementById("question").textContent = keys[order[index]][0]
        document.forms["answer_box"]["answer"].focus()
    }
    function validate_form(event) {
        event.preventDefault()
        let answer = document.forms["answer_box"]["answer"].value
        if (quiz_parameters.german_characters == "strict" && normalize_german(answer) == normalize_german(keys[order[index]][1])
        || quiz_parameters.german_characters == "lenient" && normalize_german_lenient(answer) == normalize_german_lenient(keys[order[index]][1])) {
            correct_count += 1
            quiz_data[order[index]][0] += 1
            quiz_data[order[index]][1] += 1
            result.innerHTML = "correct"
            next_word()
        }
        else if (submit_flag) {
            submit_flag = false
            quiz_data[order[index]][1] += 1
            result.innerHTML = "incorrect<br>the correct answer is: "
            + keys[order[index]][1]
            next_word()
        }
    }
    function next_word() {
        index += 1
        document.forms["answer_box"]["answer"].value = ""
        if (index < quiz_parameters.length) {
            document.getElementById("question_count").innerHTML = "Question " + (index + 1) + "/" + quiz_parameters.length
            document.getElementById("question").textContent = keys[order[index]][0]
            document.forms["answer_box"]["answer"].focus()
        }
        else {
            document.getElementById("answer_box").style.display = "none"
            document.getElementById("end_quiz").style.display = "block"
        }
    }
    function end_quiz(event) {
        event.preventDefault()
        document.getElementById("grade").innerHTML = "Questions Correct: "
        + correct_count
        + "/"
        + quiz_parameters.length
        + "<br>Grade: "
        + Math.round(correct_count/quiz_parameters.length*100*10)/10
        + "%"
        order = truncate_order(order)
        if (quiz_parameters.length == 0) {
            document.getElementById("reset_quiz").style.display = "none"
            document.getElementById("restart_quiz").style.display = "none"
        }
        else {
            document.getElementById("reset_quiz").style.display = "block"
            document.getElementById("restart_quiz").style.display = "block"
        }
        document.getElementById("quiz").style.display = "none"
        document.getElementById("quiz_report").style.display = "block"
    }
    function get_min_threshold() {
        let min_threshold = 1
        let potential_min_threshold
        for (let i = 0; i < quiz_data.length; i++) {
            if (quiz_data[i][1] == 0) {
                min_threshold = 0
            }
            else {
                potential_min_threshold = quiz_data[i][0]/quiz_data[i][1]
                if (potential_min_threshold < min_threshold) {
                    min_threshold = potential_min_threshold
                }
            }
        }
        return min_threshold
    }
    function get_max_length(question_threshold) {
        let count = 0
        for (let i = 0; i < quiz_data.length; i++) {
            if (quiz_data[i][1] == 0
            || quiz_data[i][0]/quiz_data[i][1] <= question_threshold) {
                count += 1
            }
        }
        return count
    }
    function check_length() {
        length_value = get_int(length.value)
        length.style.backgroundColor = ""
        document.getElementById("length_error").innerHTML = ""
        begin_quiz_button.style.display = "none"
        if (length_value > 0 && length_value <= max_length) {
            begin_quiz_button.style.display = "block"
        }
        else if (length.value != "") {
            length.style.backgroundColor = "#ff0000"
            document.getElementById("length_error").innerHTML = "Please Enter an Integer Between 1 and "
            + max_length
        }
    }
    const regexp = /[^a-zA-Z' ]/g
    function normalize_german(word) {
        return word
            .toLowerCase()
            .replaceAll("ä", "ae")
            .replaceAll("ö", "oe")
            .replaceAll("ü", "ue")
            .replaceAll("ß", "ss")
            .replace(regexp, "")
    }
    function normalize_german_lenient(word) {
        return word
            .toLowerCase()
            .replaceAll("ä", "a")
            .replaceAll("ö", "o")
            .replaceAll("ü", "u")
            .replaceAll("ß", "s")
            .replace(regexp, "")
    }
    function sequential_order(length) {
        order = []
        for (let i = 0; i < length; i++) {
            order.push(i)
        }
        return order
    }
    function random_order(order) {
        const order_length = order.length
        let order_copy = order
        order = []
        for (let i = 0; i < order_length; i++) {
            let random = Math.floor(order_copy.length*Math.random())
            order.push(order_copy[random])
            order_copy.splice(random, 1)
        }
        return order
    }
    function truncate_order(order) {
        let order_copy = order
        order = []
        for (let i = 0; i < order_copy.length; i++) {
            if (quiz_data[order_copy[i]][1] == 0
            || quiz_data[order_copy[i]][0]/quiz_data[order_copy[i]][1] <= quiz_parameters.question_threshold) {
                order.push(order_copy[i])
            }
            if (order.length == quiz_parameters.length) {
                break
            }
        }
        quiz_parameters.length = order.length
        return order
    }
    function get_int(value) {
        if (value.match(/\d+/) == value) {
            return value
        }
        else {
            return NaN
        }
    }
    function get_float(value) {
        if (value.match(/\d+\.\d+|\.\d+|\d+/) == value) {
            return value
        }
        else {
            return NaN
        }
    }
    (async () => {
        keys = await fetch_csv("Vocab List.csv")
        keys = keys.split("\r\n")
        keys = keys.map(row => row.split(","))
        quiz_data = await fetch_csv("Quiz Data.csv")
        quiz_data = quiz_data.split("\n")
        quiz_data = quiz_data.map(row => row.split(",").map(cell => Math.floor(cell)))
    })()
    const question_threshold = document.getElementById("question_threshold")
    let question_threshold_value
    const length_box = document.getElementById("length_box")
    const length = document.getElementById("length")
    let length_value
    length_box.style.display = "none"
    const begin_quiz_button = document.getElementById("begin_quiz")
    begin_quiz_button.style.display = "none"
    document.getElementById("question_threshold_box").addEventListener("input", function(event) {
        min_threshold = get_min_threshold()
        question_threshold_value = get_float(question_threshold.value)
        question_threshold.style.backgroundColor = ""
        document.getElementById("question_threshold_error").innerHTML = ""
        length.style.backgroundColor = ""
        document.getElementById("length_error").innerHTML = ""
        length_box.style.display = "none"
        begin_quiz_button.style.display = "none"
        if (question_threshold_value >= min_threshold*100 && question_threshold_value <= 100) {
            length_box.style.display = "block"
            max_length = get_max_length(question_threshold_value/100)
            check_length()
        }
        else if (question_threshold.value != "") {
            question_threshold.style.backgroundColor = "#ff0000"
            document.getElementById("question_threshold_error").innerHTML = "Please Enter a Number Between "
            + Math.ceil(min_threshold*100000)/1000 + " and 100"
        }
    })
    length_box.addEventListener("input", check_length)
    begin_quiz_button.addEventListener("submit", function(event) {
        event.preventDefault()
        quiz_parameters.ordering = document.getElementById("ordering").value
        quiz_parameters.submit_method = document.getElementById("submit_method").value
        quiz_parameters.german_characters = document.getElementById("german_characters").value
        quiz_parameters.length = length.value
        quiz_parameters.question_threshold = question_threshold.value/100
        order = sequential_order(keys.length)
        if (quiz_parameters.ordering == "random") {
            order = random_order(order)
        }
        order = truncate_order(order)
        begin_quiz()
    })
    let submit_flag = false
    document.getElementById("answer_box").addEventListener("input", function(event) {
        if (quiz_parameters.submit_method == "auto") {
            validate_form(event)
        }
    })
    document.getElementById("answer_box").addEventListener("submit", function(event) {
        submit_flag = true
        validate_form(event)
    })
    document.getElementById("end_quiz").addEventListener("submit", end_quiz)
    document.getElementById("reset_quiz").addEventListener("submit", begin_quiz)
    document.getElementById("restart_quiz").addEventListener("submit", function(event) {
        if (quiz_parameters.ordering == "random") {
            order = random_order(order)
        }
        begin_quiz()
    })
    document.getElementById("new_quiz").addEventListener("submit", function(event) {
        event.preventDefault()
        question_threshold.value = ""
        length.value = ""
        length_box.style.display = "none"
        begin_quiz_button.style.display = "none"
        document.getElementById("quiz_report").style.display = "none"
        document.getElementById("setup").style.display = "block"
    })
    document.getElementById("download_quiz_data").addEventListener("submit", function(event) {
        quiz_data = quiz_data.map(row => row.join(",")).join("\n")
        const blob = new Blob([quiz_data], {type: "text/csv"})
        const url = URL.createObjectURL(blob)
        const a = document.createElement("a")
        a.href = url
        a.download = "Quiz Data.csv"
        a.click()
        URL.revokeObjectURL(url)
    })
</script>
</body>
</html>
